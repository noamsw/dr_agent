<!DOCTYPE html>
<html>
<head>
    <title>AI Pharmacist Chat</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; background: #f9f9f9; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; max-width: 80%; }
        .user { background: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .ai { background: #e9e9eb; color: black; }
        .tool { font-style: italic; color: #666; font-size: 0.8em; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 10px; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <div id="input-area">
        <input type="text" id="userInput" placeholder="Ask about medication..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        const ws = new WebSocket("ws://127.0.0.1:8000/ws");
        const chat = document.getElementById('chat');
        let currentAiMsg = null;

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === "token") {
                if (!currentAiMsg) {
                    currentAiMsg = document.createElement('div');
                    currentAiMsg.className = 'msg ai';
                    chat.appendChild(currentAiMsg);
                }
                currentAiMsg.innerText += data.text;
            } else if (data.type === "tool_call") {
                appendLog(`ðŸ”§ Calling tool: ${data.name}...`);
            } else if (data.type === "final") {
                currentAiMsg = null; // Reset for next turn
            }
            chat.scrollTop = chat.scrollHeight;
        };

        function sendMessage() {
            const input = document.getElementById('userInput');
            if (!input.value) return;
            
            // Show user message
            const userMsg = document.createElement('div');
            userMsg.className = 'msg user';
            userMsg.innerText = input.value;
            chat.appendChild(userMsg);
            
            ws.send(JSON.stringify({ text: input.value }));
            input.value = "";
        }

        function appendLog(text) {
            const log = document.createElement('div');
            log.className = 'tool';
            log.innerText = text;
            chat.appendChild(log);
        }
    </script>
</body>
</html>